<script type="module">
  import { startRecording, stopRecording } from '/assets/js/recordAudio.js';

  const btnRecord = document.getElementById('btnRecord');
  const preview = document.getElementById('preview');
  const audioPreview = document.getElementById('audioPreview');
  const btnSend = document.getElementById('btnSend');
  const btnRetry = document.getElementById('btnRetry');

  let isRecording = false;
  let recordedBlob = null;
  let touchTimeout = null;

  // --- ðŸŽ¤ TAP NORMAL (desktop o tap rÃ¡pido)
  btnRecord.addEventListener('click', async () => {
    if (btnRecord.dataset.mode === "touch") return; // evitar doble disparo si viene de long press

    if (!isRecording) {
      startRecordUI();
      await startRecording();
      isRecording = true;
    } else {
      await stopRecordUI();
    }
  });

  // --- ðŸŽ¤ LONG PRESS (mÃ³vil)
  btnRecord.addEventListener('touchstart', async (e) => {
    e.preventDefault();
    btnRecord.dataset.mode = "touch";
    if (!isRecording) {
      startRecordUI();
      await startRecording();
      isRecording = true;
    }
  });

  btnRecord.addEventListener('touchend', async (e) => {
    e.preventDefault();
    if (isRecording) {
      await stopRecordUI();
    }
    setTimeout(() => delete btnRecord.dataset.mode, 400);
  });

  // --- UI Helpers
  function startRecordUI() {
    btnRecord.classList.add('recording');
    btnRecord.textContent = 'â¹ Detener';
  }

  async function stopRecordUI() {
    btnRecord.classList.remove('recording');
    btnRecord.style.display = 'none'; // ocultar botÃ³n
    recordedBlob = await stopRecording();
    isRecording = false;

    if (recordedBlob) {
      const url = URL.createObjectURL(recordedBlob);
      audioPreview.src = url;

      // ðŸ”§ Fix: asegurar que duration estÃ© listo antes de usar el player
      audioPreview.addEventListener("loadedmetadata", () => {
        audioPreview.currentTime = 0;
      }, { once: true });

      preview.style.display = 'block';
    } else {
      btnRecord.style.display = 'flex'; // fallback si no hay blob
    }
  }

  // --- ðŸ“¤ BotÃ³n enviar
  btnSend.addEventListener('click', () => {
    setTimeout(() => window.location.href = '/interaction/answers.html', 700);
  });

  // --- ðŸ”„ BotÃ³n reintentar
  btnRetry.addEventListener('click', () => {
    recordedBlob = null;
    audioPreview.pause();
    audioPreview.src = '';
    preview.style.display = 'none';
    btnRecord.style.display = 'flex';
    btnRecord.textContent = 'ðŸŽ¤ Grabar';
  });
</script>
