<script type="module">
  import { startRecording, stopRecording } from '/assets/js/recordAudio.js';

  const btnRecord = document.getElementById('btnRecord');
  const preview = document.getElementById('preview');
  const audioPreview = document.getElementById('audioPreview');
  const btnSend = document.getElementById('btnSend');
  const btnRetry = document.getElementById('btnRetry');

  let isRecording = false;
  let recordedBlob = null;

  const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

  // --- LÓGICA WEB (click para iniciar/detener) ---
  if (!isTouchDevice) {
    btnRecord.addEventListener('click', async () => {
      if (!isRecording) {
        // Iniciar grabación
        btnRecord.classList.add('recording');
        btnRecord.textContent = '⏹ Detener';
        await startRecording();
        isRecording = true;
      } else {
        // Detener grabación
        btnRecord.classList.remove('recording');
        btnRecord.style.display = 'none'; // ocultar botón
        recordedBlob = await stopRecording();
        isRecording = false;

        if (recordedBlob) {
          audioPreview.src = URL.createObjectURL(recordedBlob);
          preview.style.display = 'block';
        } else {
          btnRecord.style.display = 'flex'; // fallback si no hay blob
        }
      }
    });
  }

  // --- LÓGICA CELULAR (mantener presionado tipo WhatsApp) ---
  if (isTouchDevice) {
    btnRecord.addEventListener('touchstart', async (e) => {
      e.preventDefault();
      if (!isRecording) {
        btnRecord.classList.add('recording');
        btnRecord.textContent = 'Grabando...';
        await startRecording();
        isRecording = true;
      }
    });

    btnRecord.addEventListener('touchend', async (e) => {
      e.preventDefault();
      if (isRecording) {
        btnRecord.classList.remove('recording');
        btnRecord.style.display = 'none'; // ocultar botón
        recordedBlob = await stopRecording();
        isRecording = false;

        if (recordedBlob) {
          audioPreview.src = URL.createObjectURL(recordedBlob);
          preview.style.display = 'block';
        } else {
          btnRecord.style.display = 'flex';
        }
      }
    });
  }

  // --- Botón Enviar ---
  btnSend.addEventListener('click', () => {
    setTimeout(() => window.location.href = '/interaction/answers.html', 700);
  });

  // --- Botón Reintentar ---
  btnRetry.addEventListener('click', () => {
    recordedBlob = null;
    audioPreview.pause();
    audioPreview.src = '';
    preview.style.display = 'none';
    btnRecord.style.display = 'flex'; // mostrar botón otra vez
    btnRecord.textContent = '🎤 Grabar';
  });
</script>
